name: Website to YouTube Live (FINAL STABLE)

on:
  workflow_dispatch:

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6 saat

    steps:
      - name: Install system dependencies
        run: |
          sudo apt update
          sudo apt install -y \
            ffmpeg \
            xvfb \
            chromium-browser \
            pulseaudio \
            pactl

      # ğŸ”³ Sanal ekran (imleÃ§ tamamen kapalÄ±)
      - name: Start virtual display
        run: |
          Xvfb :99 -screen 0 720x1280x24 -nocursor &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 3

      # ğŸ”Š PulseAudio (Chromium sesi yakalamak iÃ§in)
      - name: Start PulseAudio
        run: |
          pulseaudio --start
          pactl load-module module-null-sink sink_name=virtual_sink
          pactl set-default-sink virtual_sink
          pactl set-default-source virtual_sink.monitor
          sleep 2

      # ğŸŒ Websiteâ€™i aÃ§ (Ã‡EVÄ°RÄ° / INFOBAR / POPUP TAMAMEN KAPALI)
      - name: Open website in Chromium
        env:
          DISPLAY: :99
        run: |
          chromium-browser \
            --no-sandbox \
            --disable-dev-shm-usage \
            --disable-gpu \
            --disable-infobars \
            --lang=tr-TR \
            --disable-translate \
            --disable-features=Translate,TranslateUI \
            --no-first-run \
            --no-default-browser-check \
            --disable-notifications \
            --autoplay-policy=no-user-gesture-required \
            --window-size=720,1280 \
            --kiosk \
            "https://macsavasi.github.io/macsavasi/" &
          sleep 8

      # ğŸ“¡ YouTube Live Stream (Video + Site Sesi)
      - name: Stream to YouTube Live
        env:
          YT_KEY: ${{ secrets.YT_KEY }}
        run: |
          ffmpeg -re \
            -f x11grab \
            -draw_mouse 0 \
            -video_size 720x1280 \
            -framerate 30 \
            -i :99 \
            -f pulse \
            -i default \
            -c:v libx264 \
            -preset veryfast \
            -pix_fmt yuv420p \
            -b:v 2000k \
            -maxrate 2000k \
            -bufsize 4000k \
            -g 60 \
            -c:a aac \
            -b:a 128k \
            -ar 44100 \
            -f flv \
            rtmp://a.rtmp.youtube.com/live2/$YT_KEY
