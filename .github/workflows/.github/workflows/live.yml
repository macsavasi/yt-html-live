name: Website to YouTube Live (FINAL LOCKED)

on:
  workflow_dispatch:

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    env:
      DISPLAY: :99

    steps:
      - name: Update system
        run: sudo apt update

      - name: Install dependencies
        run: |
          sudo apt install -y \
            ffmpeg \
            xvfb \
            chromium-browser \
            pulseaudio \
            x11-utils

      # ================================
      # START XVFB (NO CURSOR)
      # ================================
      - name: Start Xvfb
        run: |
          Xvfb :99 -screen 0 1080x1920x24 -nocursor &
          sleep 5
          xdpyinfo -display :99

      # ================================
      # AUDIO PIPELINE
      # ================================
      - name: Start PulseAudio
        run: |
          pulseaudio --start
          pactl load-module module-null-sink sink_name=vsink
          pactl set-default-sink vsink
          pactl set-default-source vsink.monitor
          sleep 3

      # ================================
      # OPEN WEBSITE (KIOSK, NO UI)
      # ================================
      - name: Open website in Chromium
        run: |
          chromium-browser \
            --no-sandbox \
            --disable-dev-shm-usage \
            --disable-gpu \
            --disable-infobars \
            --disable-translate \
            --disable-features=Translate,TranslateUI \
            --lang=tr-TR \
            --no-first-run \
            --no-default-browser-check \
            --disable-notifications \
            --autoplay-policy=no-user-gesture-required \
            --window-size=1080,1920 \
            --kiosk \
            "https://macsavasi.github.io/macsavasi/" &
          sleep 10

      # ================================
      # STREAM TO YOUTUBE (LOCKED)
      # ================================
      - name: Stream to YouTube Live
        env:
          YT_KEY: ${{ secrets.YT_KEY }}
        run: |
          ffmpeg -loglevel info -stats -re \
            -f x11grab \
            -draw_mouse 0 \
            -video_size 1080x1920 \
            -framerate 30 \
            -i :99.0 \
            -f pulse \
            -i default \
            -c:v libx264 \
            -preset veryfast \
            -pix_fmt yuv420p \
            -b:v 3500k \
            -maxrate 3500k \
            -bufsize 7000k \
            -g 60 \
            -c:a aac \
            -b:a 128k \
            -ar 44100 \
            -f flv \
            rtmp://a.rtmp.youtube.com/live2/$YT_KEY
