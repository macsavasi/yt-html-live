name: Website to YouTube Live (FINAL LOCKED)

on:
  workflow_dispatch:

jobs:
  live:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # 6 saat

    steps:
      # ================================
      # SYSTEM UPDATE
      # ================================
      - name: Update system
        run: |
          sudo apt update

      # ================================
      # DEPENDENCIES
      # ================================
      - name: Install dependencies
        run: |
          sudo apt install -y \
            ffmpeg \
            xvfb \
            chromium-browser \
            pulseaudio \
            unclutter

      # ================================
      # VIRTUAL DISPLAY (NO CURSOR)
      # ================================
      - name: Start Xvfb (cursor disabled)
        run: |
          Xvfb :99 -screen 0 720x1280x24 -nocursor &
          echo "DISPLAY=:99" >> $GITHUB_ENV
          sleep 3

      # EXTRA CURSOR KILL (GARANTÄ°)
      - name: Hide mouse cursor
        run: |
          unclutter -idle 0 -root &

      # ================================
      # AUDIO PIPELINE (CHROMIUM â†’ FFMPEG)
      # ================================
      - name: Start PulseAudio
        run: |
          pulseaudio --start
          pactl load-module module-null-sink sink_name=vsink
          pactl set-default-sink vsink
          pactl set-default-source vsink.monitor
          sleep 3

      # ================================
      # OPEN WEBSITE (NO TRANSLATE / NO UI / NO POPUP)
      # ================================
      - name: Open website in Chromium (LOCKED)
        run: |
          chromium-browser \
            --no-sandbox \
            --disable-dev-shm-usage \
            --disable-gpu \
            --disable-infobars \
            --disable-notifications \
            --disable-popup-blocking \
            --disable-translate \
            --disable-features=Translate,TranslateUI,TranslateBubble,OptimizationHintsFetching \
            --lang=en-US \
            --force-dark-mode \
            --no-first-run \
            --no-default-browser-check \
            --autoplay-policy=no-user-gesture-required \
            --disable-session-crashed-bubble \
            --disable-restore-session-state \
            --disable-component-update \
            --window-size=720,1280 \
            --kiosk \
            "https://macsavasi.github.io/macsavasi/" &
          sleep 10

      # ================================
      # STREAM TO YOUTUBE (BLOCKING)
      # ================================
      - name: Stream to YouTube Live
        env:
          YT_KEY: ${{ secrets.YT_KEY }}
        run: |
          echo "==============================="
          echo "ðŸŽ¥ FFmpeg STREAM BAÅžLIYOR"
          echo "==============================="

          ffmpeg -loglevel info -stats -re \
            -f x11grab \
            -video_size 720x1280 \
            -framerate 30 \
            -i :99 \
            -f pulse \
            -i default \
            -c:v libx264 \
            -preset veryfast \
            -pix_fmt yuv420p \
            -b:v 2000k \
            -maxrate 2000k \
            -bufsize 4000k \
            -g 60 \
            -c:a aac \
            -b:a 128k \
            -ar 44100 \
            -f flv \
            rtmp://a.rtmp.youtube.com/live2/${YT_KEY}
